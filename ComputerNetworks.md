### 计算机网络概述

计算机网络是**互连**的，**自治**的计算机集合。

- 自治：计算机之间没有主从关系，一个计算机不能控制另一个计算机
- 互连：计算机之间要互连互通，通过通信链路，e.g. 光纤、无线、电缆

计算机通过**交换网络**连接位置远 数量大的计算机。

![1607552135967](C:/Users/wenyu/AppData/Roaming/Typora/typora-user-images/1607552135967.png)

 **Internet**：

网络把主机连接起来，而互连网（internet）是把多种不同的网络连接起来，因此互连网是网络的网络。而互联网（Internet）是全球范围的互连网。

**网络协议**(network protocol)

约定计算机网络中数据传输、交换的规则。协议规定交换信息的**格式**、**意义**、**顺序**、以及收到信息发生的**动作**。

网络协议的三要素：

- 语法(syntax) : 信息的格式，e.g.底层信息0101
- 语义(semantics): 信息的含义
- 时序(Timing): 交换信息的时间顺序

#### 计算机网络结构

- 网络边缘

  - 通过接入网络，或者物理介质连接网络
  - 由主机构成，主机运行网络应用程序 
  - 主机之间的通信方式
    - 客户/服务器类型：客户发送请求，服务器接收请求
    - 对等应用模型 peep-peep/p2p：不区分客户服务器，每台主机平等
      - e.g. QQ

- 网络核心：互连的路由器，或者转发设备，将网络边缘加入网络核心

  - 接入方式

    - 独占：一台主机独占所有带宽
    - 共享：主机共享带宽

  - 关键功能：

    - 路由：源到目的经过的路径

    - 转发：将数组从路由器的输入端口交换到输出端看

      本地转发表：

      ![1607553900022](C:/Users/wenyu/AppData/Roaming/Typora/typora-user-images/1607553900022.png)

Internet 结构：网络之网络

![1607554190048](C:/Users/wenyu/AppData/Roaming/Typora/typora-user-images/1607554190048.png)

主机通过连接到ISP接入网络，不同国家有自己的ISP, ISP之间互连，从而任意主机之间可以互连

#### 数据交换

目的：如果任意两个主机之间希望通信，可以在两个主机之间建立直接连接。但这种方法建立了过多链路。可以通过讲主机与交换设备相连。交换设备与交换设备相连，从而达到互连。

数据交换的类型：

- 电路交换：电路交换用于电话通信系统，两个用户要通信之前需要建立一条专用的物理链路，并且在整个通信过程中始终**占用**该链路。由于通信的过程中不可能一直在使用传输线路，因此电路交换对线路的利用率很低，往往不到 10%。
- 报文交换：将一整条报文（信息）当做整体发送。
- 分组交换：将报文拆成一系列较小的数据包，对每个包补充头部信息(e.g.地址，组号)，构成**分组**。源主机将一系列分组通过路由器转发至目的主机。目的主机等收到所有分组后，合成至一条消息。
  - 分组交换可能会发生丢包和延迟
  - 延迟可能是等待数据转发的传输延迟，或者数据在路由器中排队等待处理的延迟
  - 丢包：路由器的缓存有限，如果缓存已满，但还有分组到达，到达分组会被丢弃

分组交换：链路可以并行传输数据，报文交换相当于串行传输。分组交换所需的传输时间段，路由器缓存低。

多路复用 (multiplexing): 把链路资源划分成片，并把每片资源分配给一个请求。

#### 时延

- 排队延迟：分组在路由器的输入队列和输出队列中排队等待的时间，取决于路由器的堵塞状态
- 处理延迟：主机或路由器收到分组时进行处理所需要的时间，例如分析首部、从分组中提取数据、进行差错检验或查找适当的路由等。
- 传输延迟：从传输数据的第一个比特开始，到最后以一比特结束需要的时间。$ delay = \frac{L(bits)}{R (bits/sec)}$ ，由分组长度和链路带宽决定
- 传播延迟：电磁波在信道中传播所需要花费的时间，电磁波传播的速度接近光速。

#### 计算机网络性能

- 速率：又称比特率，单位时间内传输的信息量，常见单位：bps (bit/s), kb/s, Mb/s
- 带宽
  - 通信领域里，信号的最高频率与最低频率之差，单位: 赫兹Hz
  - 网络的带宽指数字信道能传输的最高速率，单位bps
- 时延带宽积： 传播时延 * 带宽。代表链路中能容纳的比特长度，当第一比特到达链路结尾时，链路中容纳多少比特
- 丢包率：丢包数 / 已发分组总数
- 吞吐量(throughput): 在发送端与接收端之间传送的数据速率，单位b/s

#### 计算机网络体系结构

计算机网络使用分层结构，每层都遵循某些网络协议，实现本层功能。

上下层存在服务关系，上层使用下层服务，上层通过接口与下层进行交互。

OSI模型：由国际标准化组织ISO提出的分层网络模型。当时市场存在多个网络模型，ISO提出来一个统一的国际网络模型。

![1607613164969](C:/Users/wenyu/AppData/Roaming/Typora/typora-user-images/1607613164969.png)

![img](https://camo.githubusercontent.com/bbe716e11ca979af077d83837c9524453a22219919f65aa791aedacfdbfc7e5b/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f30666136633233372d613930392d346532612d613737312d3263353438356364386365302e706e67)

##### OSI 7层模型

- 应用层：为特定应用程序提供数据传输服务，例如 HTTP、DNS 等协议。数据单位为报文。

- 表示层：处理信息的语法和语义问题

  - 数据表示转化：源主机将数据转换为主机独立的编码
  - 加密/解密
  - 压缩/解压缩

- 会话层：负责连接中的会话管理。

  - 对话同步：在数据中插入同步点。如果数据在传输过程中中断，下次可以从最近的同步点恢复。

- 传输层：负责端到端、从源到目的进程之间的传输。发送方在传输层讲数据切割成端，在接收方进行重组。

  - SAP寻址：传输层确保报文发送给正确进行, e.g. 端口号
  - 端口到端口连接的建立、断开

- 网络层：负责将数组分组从源主机传输到目的主机。在网络层传输中跨越多个网络。

  - 逻辑寻址：在信息头添加全局唯一的逻辑地址，比如ip地址。这个地址在传输中不变，物理寻址在传输过程中不断改变，模拟jump的过程。
  - 路由：帮助路由器选择路径，最终抵达目的主机

- 数据链路层：负责（物理链路直接相连的）结点之间的数据传输，单位为帧。

  网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的主机提供数据传输服务。数据链路层把网络层传下来的分组封装成帧。

  - 组帧(Framing): 将来自网络层的数据添加头部尾部信息
    - 物理寻址：在帧头中增加发送/接受端的物理地址
    - 流量控制：匹配发送端的发送速度和接收端的接受速度，避免发送速度过快，堆满缓存
    - 访问控制：决定哪个设备拥有链路的访问使用权

- 物理层：实现比特在物理介质上的传输。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。

  - 接口特性：机械特性（接口的几何形状?）、电气特性（多大电压传输？）、功能特性（接口的引脚功能）、规程特性（接口的工作过程？哪个引脚先接受信号？）
  - 比特编码：如何用信号的特征表示01
  - 数据传输速率：物理层数据以多快速度传输
  - 比特同步/时钟同步
  - 传输模式：单工（单向通信）、半双工（交替双向 e.g.对讲机）、全双工

端到端层：上四层，这四层只在源主机和目的主机上进行处理。

数据从上至下进行数据封装。数据封装的目的是增加控制信息，比如地址，协议控制（优先级信息、安全控制）。

### 应用层

应用层协议包括： 

- 消息类型：请求/响应
- 消息的语法：消息中有哪些字段
- 字段的语义：每个字段中消息的含义

网络层服务的需求：

- 数据可靠性：有些服务能够容忍一定的数据丢失，e.g. 网络电话，但有些服务要求100%的数据传输：文件传输
- 延迟：有些服务可以容忍高延迟，但有些应用要求低延迟
- 带宽：有些应用对网络带宽有要求，e.g. 网络视频，但有些应用可以适应任何带宽

#### 进程间通信

进程间通信使用socket发送/接受消息。

进程寻址：使用ip地址定位主机。但同一主机可能同时有多个进程需要通信，利用ip地址+端口号标志不同进程。

#### HTTP 超文本传输协议

HTTP使用TCP传输服务，连接流程是：

- 服务器在80端口等待客户请求
- 浏览器发送到服务器的TCP请求
- 服务器接收TCP连接
- 客户端与服务器交换信息
- 关闭TCP连接

HTTP是**无状态**协议，即服务器不维护客户端过去发送请求的消息。

根据每个链接传输对象的数量，HTTP连接分为两种类型：

- 非持久性连接：每个tcp连接最多传输一个对象，早期http协议是这种类型
  - e.g. 假定用户在浏览器输入url www.someschool.edu/home.index (包括10个jpeg)
    1. 客户端向edu服务器的80端口发送tcp连接请求
    2. 服务器接收80端口的tcp请求
    3. 客户端发送http请求，请求对象为/home.index
    4. 服务器解析请求，发送响应消息给客户端
    5. 服务器关闭tcp连接
    6. 客户端解析响应信息，发现有10个指向jpeg对象的链接
    7. 客户端为每个对象，重复步骤1-5
  - 缺点：操作系统需要给每个tcp资源开销资源
- 持久性连接：每个tcp连接允许传输多个对象，http v1.1之后默认是这种类型
  - 无流水的持久性连接：客户端收到前一个响应后才发送新的请求
  - 带有流水机制的持久性连接：客户端只要遇到一个引用对象就发出请求，http1.1的默认选项

HTTP的消息格式：

- 请求消息 request

  ```
  Get /somedir/page.html HTTP/1.1
  Host: www.someschool.edu
  User-agent: mozilla/4.0
  Connection: close
  ```

  第一行是请求行，包括请求类型(Get/post) 及请求资源(URL), HTTP版本

  第二行之后是头部信息。服务器根据不同浏览器，不同语言会采取不同操作。

- 响应消息 response

  ```
  HTTP/1.1 200 OK
  Connection: close
  Date: Thu, 06 Aug 1998 12:00:15 GMT
  Server: Apache/1.3
  Content-Length: 6981
  Coneect-type: text/html
  data data
  ```

  - HTTP响应的状态代码

    200 -> OK

    301 -> Move permanently

    400 -> Bad request

    404 -> Not found

#### Cookie

由于http协议是无状态的，不保留客户发送请求的历史记录。但有些网站(例如电商)需要保留客户的会话状态及在线信息，提出了cookie技术。它是为了辨别用户身份，进行session追踪，从而存储在客户端本地的数据。

Cookie的组件

- http响应消息的cookie头部行
- http请求消息的cookie头部行
- 保存着客户端上的cookie文件，由浏览器管理
- 服务器端的数据库

Cookie使用流程：

![1607882639417](C:/Users/wenyu/AppData/Roaming/Typora/typora-user-images/1607882639417.png)

### 传输层

TCP:

- 客户机/服务器间需要建立连接
- 可靠的传输，保证数据不丢失

UDP:

- 无连接
- 不可靠的数据传输